version: '3.8'
services:
  nextcloud:
    container_name: nextcloud
    privileged: true
    security_opt:
      - apparmor:unconfined
    cap_add:
      - SYS_ADMIN
    image: docker.sunet.se/drive/nextcloud-custom:26.0.3.3-4
    ports:
      - 8000:80
    volumes:
      - ./nextcloud/config:/config
      - ./nextcloud/local_apps:/local_apps
      - ./nextcloud/scripts:/scripts
      - /dev/fuse:/dev/fuse
    entrypoint:
      - /scripts/entrypoint.sh
    command:
      - apache2-foreground
  garage:
    container_name: garage
    image: dxflrs/garage:v0.8.0
    ports:
      - 3900:3900
    restart: unless-stopped
    volumes:
      - ./garage/garage.toml:/etc/garage.toml
      - ./garage/data:/var/lib/garage/data
      - ./garage/bin/busybox:/bin/busybox
      - ./garage/meta:/var/lib/garage/meta
      - ./garage/scripts/entrypoint.sh:/entrypoint.sh
    entrypoint:
      - /bin/busybox
      - sh
      - /entrypoint.sh
  mariadb:
    image: mariadb
    container_name: mariadb
    environment:
      MYSQL_ROOT_PASSWORD: nextcloud
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: nextcloud
    volumes:
      - ./mariadb/init.d:/docker-entrypoint-initdb.d
      - ./mariadb/data:/var/lib/mysql
    ports:
      - "3306:3306"
